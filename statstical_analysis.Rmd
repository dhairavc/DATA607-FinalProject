---
title: "statistical_exploratory_analysis"
author: "Salma Elshahawy"
date: "11/18/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Which variables we are interested in

variable         | description
---------------- | -----------
`arrest_date`    | Exact date of arrest for the reported event.
`ofns_desc`      | Description of internal classification corresponding with KY code (more general category than PD description).
`arrest_boro`    | Borough of arrest. B(Bronx), S(Staten Island), K(Brooklyn), M(Manhattan), Q(Queens)
`language`       | language of school where professor received education: english or non-english.
`age_group`      | Perpetrator’s age within a category.
`perp_sex`       | Perpetrator’s sex description.
`perp_race`      | Perpetrator’s race description.
`x_coord_cd`     | Midblock X-coordinate for New York State Plane Coordinate System, Long Island Zone, NAD 83, units feet (FIPS 3104).
`y_coord_cd`     | Midblock Y-coordinate for New York State Plane Coordinate System, Long Island Zone, NAD 83, units feet (FIPS 3104)
`latitude`       | Latitude coordinate for Global Coordinate System, WGS 1984, decimal degrees (EPSG 4326)
`longitude`      | Longitude coordinate for Global Coordinate System, WGS 1984, decimal degrees (EPSG 4326)

```{r message=FALSE, warning=FALSE}
if (!require('dplyr')) install.packages ('dplyr')
if (!require('RSocrata')) install.packages ('RSocrata')
if (!require('tidyverse')) install.packages ('tidyverse')
if (!require('ggplot2')) install.packages ('ggplot2')
if (!require('readxl')) install.packages ('readxl')
if (!require('plyr')) install.packages('plyr')
```

```{r}
app_token <- "Fm6ShrlqYtvnNx0IB9N0EyrfT"

## used SoQl to filter the imported columns and to extract years as an integer from the date
system.time(arrests_df <- read.socrata("https://data.cityofnewyork.us/resource/8h9b-rp9u.csv?$where=arrest_date >= '2014-01-01T00:00:00.000'&$select=date_extract_y(arrest_date) as year,ofns_desc,arrest_boro,age_group, perp_sex, perp_race",
                     app_token = app_token))
```

```{r}
head(arrests_df, 10)
```

```{r}
bronx_url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTpI6SZYx2-kMLhQbprpfgdL0qp0gY4He-VgCWlLpAMkRsXFx-7T7DcIr-XADJCa6a_3O2tigtla2EM/pub?gid=0&single=true&output=csv"
queens_url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTpI6SZYx2-kMLhQbprpfgdL0qp0gY4He-VgCWlLpAMkRsXFx-7T7DcIr-XADJCa6a_3O2tigtla2EM/pub?gid=1191228861&single=true&output=csv"
brooklyn_url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTpI6SZYx2-kMLhQbprpfgdL0qp0gY4He-VgCWlLpAMkRsXFx-7T7DcIr-XADJCa6a_3O2tigtla2EM/pub?gid=1054422077&single=true&output=csv"
manhattan_url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTpI6SZYx2-kMLhQbprpfgdL0qp0gY4He-VgCWlLpAMkRsXFx-7T7DcIr-XADJCa6a_3O2tigtla2EM/pub?gid=652704166&single=true&output=csv"
staten_url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTpI6SZYx2-kMLhQbprpfgdL0qp0gY4He-VgCWlLpAMkRsXFx-7T7DcIr-XADJCa6a_3O2tigtla2EM/pub?gid=1149424970&single=true&output=csv"

bronx <- read.csv(bronx_url, skip = 2, stringsAsFactors = FALSE) 
queens <- read.csv(queens_url, skip = 2, stringsAsFactors = FALSE)
brooklyn <- read.csv(brooklyn_url, skip = 2, stringsAsFactors = FALSE)
manhattan <- read.csv(manhattan_url, skip = 2, stringsAsFactors = FALSE)
staten <- read.csv(staten_url, skip = 2, stringsAsFactors = FALSE)
```

```{r}
clean_table <- function (table) {
  table_content <- table %>%
    na.omit()
  colnames(table_content) = c("arrest_boro","year","month","labor_force","employed","unemployed","unemployment_rate")
  final_table <- table_content %>%
    select(arrest_boro, year, labor_force, employed, unemployed, unemployment_rate) 
  return(final_table)
}


bronx_income <- clean_table(bronx)
queens_income <- clean_table(queens)
brooklyn_income <- clean_table(brooklyn)
manhattan_income <- clean_table(manhattan)
staten_income <- clean_table(staten)

income_table <- Reduce(function(...) merge(..., all=T), list(bronx_income, queens_income, brooklyn_income, manhattan_income, staten_income))

income_table 
```

## analysis
```{r}
boxplot(unemployment_rate ~ arrest_boro,
        data = income_table,
        main = "Different boxplot for uneployment rate in the 5 counties over years",
        ylab = "Unemployment rate %",
        xlab = "",
        col = "cyan",
        border = "blue", 
        las = 1)
```

````{r}
## I need to change symbole to full name to be able to merge. 
by_boro <- arrests_df
by_boro$arrest_boro <- revalue(arrests_df$arrest_boro, c("B"="Bronx", "Q"="Queens", "K"="Brooklyn", "S"="Staten Island", "M"="Manhattan"))
head(by_boro)
```

```{r}
merged <- dplyr::left_join(grouped_boro, income_table, by = "arrest_boro")
merged
```


It seems that overall, Bronx had the highest unemployment rate among other areas. Let's invistigate the unemployment rate over the years and if it is related to crime rate for the same years?

```{r}
# Data Prep
income_table$boro <- rownames(income_table)  # create new column for car names
income_table$income_z <- round((income_table$unemployed - mean(income_table$unemployed))/sd(income_table$unemployed), 2)  # compute normalized mpg
income_table$income_type <- ifelse(income_table$income_z < 0, "below", "above")  # above / below avg flag
income_table <- income_table[order(income_table$income_z), ]  # sort
income_table$boro <- factor(income_table$boro, levels = income_table$boro)  # convert to factor to retain sorted order in plot.

# Diverging Barcharts
ggplot(income_table, aes(x=boro, y=income_z, label=income_z)) + 
  geom_bar(stat='identity', aes(fill=income_type), width=.5)  +
  scale_fill_manual(name="Mileage", 
                    labels = c("Above Average", "Below Average"), 
                    values = c("above"="#00ba38", "below"="#f8766d")) + 
  labs(subtitle="Normalised mileage from 'mtcars'", 
       title= "Diverging Bars") + 
  coord_flip()
```



```{r}
#arrests_df <- arrests_df %>% rename(date = month, offense = ofns_desc) 
# arrests_by_year <- arrests_df %>% separate(year, c("year", "month", "day"), sep = '-')
grouped_offenses <- arrests_df %>% group_by(arrest_boro, ofns_desc) %>% summarize(count = n()) %>% arrange(desc(count))
```

```{r}
grouped_boro <- arrests_df %>% group_by(arrest_boro) %>% summarize(count = n()) %>% arrange(desc(count))
```

```{r}
ggplot(grouped_boro, aes(x = reorder(arrest_boro, -count), y = count)) + 
  geom_bar(stat = 'identity', fill= 'lightblue') + 
  geom_text(aes(label=count), size = 5, hjust=1.2) +
  coord_flip() + 
  xlab("borough") + ylab("count") + ggtitle("Borough Aggregation") 
```

```{r message=FALSE, warning=FALSE}
ggplot(grouped_offenses %>% top_n(25), aes(x = reorder(ofns_desc, -count), y = count)) + 
  geom_bar(stat = 'identity', fill= 'lightblue') + 
  coord_flip() + 
  xlab("offense") + ylab("count")  + ggtitle("Types of Crimes Aggregation") +
  theme(axis.text.x = element_text(size=10), axis.text.y = element_text(size=8))
```

```{r message=FALSE, warning=FALSE}
ggplot(grouped_offenses %>% top_n(-25), aes(x = reorder(ofns_desc, -count), y = count)) + 
  geom_bar(stat = 'identity', fill= 'lightblue') + 
  coord_flip() + 
  xlab("offense") + ylab("count")  + ggtitle("Types of Crimes Aggregation") +
  theme(axis.text.x = element_text(size=10), axis.text.y = element_text(size=8))
```

```{r}
drugs <- arrests_df %>% filter(ofns_desc == 'DANGEROUS DRUGS') %>% group_by(year, arrest_boro) %>% summarize(count = n())
```

```{r}
ggplot(drugs, aes(x = year, y = count, color = arrest_boro)) +
  geom_jitter() + 
  xlab("date") + ylab("count")  + ggtitle("Dangerous Drugs Crime by Bourough") +
  theme(axis.text.x = element_text(size=10), axis.text.y = element_text(size=8))
```


```{r message=FALSE, warning=FALSE}
ggplot(arrests_df, aes(x = age_group, fill = perp_sex)) + 
  geom_histogram(stat = "count", position=position_dodge()) +
  scale_fill_brewer(palette="Blues") + 
  xlab("age") + ylab("count")  + ggtitle("Perpetrator Age Group and Gender Distribution") 
```






